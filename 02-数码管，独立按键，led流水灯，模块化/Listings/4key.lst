C51 COMPILER V9.60.7.0   4KEY                                                              03/31/2024 10:39:53 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE 4KEY
OBJECT MODULE PLACED IN .\Objects\4key.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE 4key.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\4key
                    -.lst) OBJECT(.\Objects\4key.obj)

line level    source

   1          //独立按键长按，短按控制
   2          #include <STC15F2K60S2.H>
   3          #include "shuma.h"
   4          #include "typedef.h"
   5          
   6          //读出的值为0即为按下
   7          sbit KEY_IN_1 = P3^3;sbit KEY_IN_2 = P3^2;
   8          sbit KEY_IN_3 = P3^1;sbit KEY_IN_4 = P3^0;
   9          
  10          extern u32 number;//传回main
  11          
  12          u16 keytimelen[4]={0,0,0,0};//长按时间
  13          
  14          //按键行为函数（示例为数码管增加数字）
  15          void keyaction4(u8 i)
  16          {
  17   1              switch(i)
  18   1              {
  19   2                      case 0:number++;break;
  20   2                      case 1:number--;break;
  21   2                      case 2:number=number*2;break;
  22   2                      case 3:number=number/2;break;
  23   2              }
  24   1              warma_none_zero(3,5,number); //按键事件中更新数码管显示
  25   1      }
  26          
  27          //独立按键扫描函数(在中断调用)
  28          void keyscan4()
  29          {
  30   1              u8 i;
  31   1              //2*8ms延时判断
  32   1              static u8 keytmp[4] = {0xff,0xff,0xff,0xff};
  33   1              //防止重复对比
  34   1              static u8 keyold[4] = {1,1,1,1};
  35   1              static u8 keynow[4] = {1,1,1,1};
  36   1              //长按起始时间
  37   1              static u16 timemax[4] = {1000,1000,1000,1000};
  38   1              
  39   1              keytmp[0] = (keytmp[0]<<1)| KEY_IN_1;
  40   1              keytmp[1] = (keytmp[1]<<1)| KEY_IN_2;
  41   1              keytmp[2] = (keytmp[2]<<1)| KEY_IN_3;
  42   1              keytmp[3] = (keytmp[3]<<1)| KEY_IN_4;
  43   1              
  44   1              for(i=0;i<4;i++)
  45   1              {
  46   2                      if(keytmp[i] == 0xff)
  47   2                      {
  48   3                              keynow[i] = 1;
  49   3                              keytimelen[i] = 0;
  50   3                      }
  51   2                      if(keytmp[i] == 0x00)
  52   2                      {
  53   3                              keynow[i] = 0;
  54   3                              keytimelen[i] += 2;
C51 COMPILER V9.60.7.0   4KEY                                                              03/31/2024 10:39:53 PAGE 2   

  55   3                      }
  56   2              }
  57   1              
  58   1              for(i=0;i<4;i++)
  59   1              {
  60   2                      //短按检测
  61   2                      if(keyold[i] != keynow[i])
  62   2                      {
  63   3                              if(keynow[i]==0)
  64   3                              {
  65   4                                      keyaction4(i);
  66   4                              }
  67   3                              keyold[i]=keynow[i];
  68   3                      }
  69   2                      //长按检测
  70   2                      if(keytimelen[i] < 60000|timemax[i] < 60000)
  71   2                      {                       
  72   3                              if(keytimelen[i] > timemax[i])
  73   3                              {
  74   4                                      keyaction4(i);
  75   4                                      timemax[i] += 100;//0.1ms+1
  76   4                              }
  77   3                      }
  78   2                      else
  79   2                      {
  80   3                              keytimelen[i] = 900;
  81   3                              timemax[i] = 1000;
  82   3                      }
  83   2              }
  84   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    447    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     28       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
